{% load common_tags wagtailcore_tags %}

{% if page and page.get_ancestors|length > 1 %}
    {# Fetch specific-page instances in bulk, then filter to only visible items. #}
    {% with visible=page.get_ancestors|slice:"1:"|specific_pages|visible_breadcrumb_ancestors %}
        <nav aria-label="Breadcrumb" class="mb-4">
            <ol class="flex flex-wrap items-center gap-2 text-sm">
                <li class="inline-flex items-center">
                    <a href="/" class="text-primary hover:underline focus:outline-none focus:underline">
                        Home
                    </a>
                </li>

                {% for ancestor in visible %}
                    <li class="inline-flex items-center">
                        <span class="mx-1">/</span>
                        <a href="{% pageurl ancestor %}" class="text-primary hover:underline focus:outline-none focus:underline">
                            {{ ancestor.title }}
                        </a>
                    </li>
                {% endfor %}

                <li class="inline-flex items-center" aria-current="page">
                    <span class="mx-1">/</span>
                    <span>{{ page.title }}</span>
                </li>
            </ol>
        </nav>

        <!-- Structured breadcrumb data -->
        <script type="application/ld+json">
            {
                "@context": "https://schema.org",
                "@type": "BreadcrumbList",
                "itemListElement": [
                    {
                        "@type": "ListItem",
                        "position": 1,
                        "name": "Home",
                        "item": "{{ request.scheme }}://{{ request.site.hostname }}/"
                    }{% for ancestor in visible %},
                        {
                            "@type": "ListItem",
                            "position": {{ forloop.counter|add:1 }},
                            "name": "{{ ancestor.title }}",
                            "item": "{{ request.scheme }}://{{ request.site.hostname }}{% pageurl ancestor %}"
                        }{% endfor %},
                    {
                        "@type": "ListItem",
                        "position": {{ visible|length|add:2 }},
                        "name": "{{ page.title }}",
                        "item": "{{ request.scheme }}://{{ request.site.hostname }}{% pageurl page %}"
                    }
                ]
            }
        </script>
    {% endwith %}
{% endif %}
